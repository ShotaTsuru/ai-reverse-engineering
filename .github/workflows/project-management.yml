name: AI Project Management

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'ã‚¢ã‚¯ã‚·ãƒ§ãƒ³'
        required: true
        type: choice
        options:
          - 'create-project'
          - 'add-issue-to-project'
          - 'update-status'
          - 'create-milestone'
      project_title:
        description: 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¤ãƒˆãƒ«ï¼ˆæ–°è¦ä½œæˆæ™‚ï¼‰'
        required: false
        type: string
      project_description:
        description: 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆèª¬æ˜ï¼ˆæ–°è¦ä½œæˆæ™‚ï¼‰'
        required: false
        type: string
      project_number:
        description: 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç•ªå·'
        required: false
        type: string
      issue_number:
        description: 'Issueç•ªå·'
        required: false
        type: string
      status:
        description: 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹'
        required: false
        type: choice
        options:
          - 'Todo'
          - 'In Progress'
          - 'In Review'
          - 'Done'
      priority:
        description: 'å„ªå…ˆåº¦'
        required: false
        type: choice
        options:
          - 'Low'
          - 'Medium'
          - 'High'
          - 'Urgent'
  issues:
    types: [opened, closed]
  pull_request:
    types: [opened, closed]

jobs:
  ai-project-management:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create Project
        if: github.event.inputs.action == 'create-project'
        run: |
          PROJECT_URL=$(gh project create \
            --title "${{ github.event.inputs.project_title }}" \
            --owner @me)
          
          echo "ğŸ‰ æ–°ã—ã„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸï¼š"
          echo "ğŸ“‹ ã‚¿ã‚¤ãƒˆãƒ«: ${{ github.event.inputs.project_title }}"
          echo "ğŸ”— URL: $PROJECT_URL"
          
          # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç•ªå·ã‚’å–å¾—
          PROJECT_NUMBER=$(echo $PROJECT_URL | grep -o '/projects/[0-9]*' | grep -o '[0-9]*')
          echo "PROJECT_NUMBER=$PROJECT_NUMBER" >> $GITHUB_ENV
          
          # æ¨™æº–ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ 
          gh project field-create $PROJECT_NUMBER \
            --name "Priority" \
            --single-select-option "Low" \
            --single-select-option "Medium" \
            --single-select-option "High" \
            --single-select-option "Urgent"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Add Issue to Project
        if: github.event.inputs.action == 'add-issue-to-project' || github.event_name == 'issues'
        run: |
          ISSUE_NUM="${{ github.event.inputs.issue_number || github.event.issue.number }}"
          PROJECT_NUM="${{ github.event.inputs.project_number || '1' }}"
          
          # Issueã‚’Projectã«è¿½åŠ 
          gh project item-add $PROJECT_NUM --owner ${{ github.repository_owner }} --url "${{ github.server_url }}/${{ github.repository }}/issues/$ISSUE_NUM"
          
          echo "âœ… Issue #$ISSUE_NUM ã‚’Project #$PROJECT_NUM ã«è¿½åŠ ã—ã¾ã—ãŸ"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update Item Status
        if: github.event.inputs.action == 'update-status'
        run: |
          PROJECT_NUM="${{ github.event.inputs.project_number }}"
          ISSUE_NUM="${{ github.event.inputs.issue_number }}"
          STATUS="${{ github.event.inputs.status }}"
          
          # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¢ã‚¤ãƒ†ãƒ ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°
          ITEM_ID=$(gh project item-list $PROJECT_NUM --owner ${{ github.repository_owner }} --format json | jq -r ".[] | select(.content.number == $ISSUE_NUM) | .id")
          
          if [ -n "$ITEM_ID" ]; then
            gh api graphql \
              -f query='
                mutation($project: ID!, $item: ID!, $field: ID!, $value: String!) {
                  updateProjectV2ItemFieldValue(input: {
                    projectId: $project
                    itemId: $item
                    fieldId: $field
                    value: { text: $value }
                  }) {
                    projectV2Item { id }
                  }
                }' \
              -f project=$(gh project view $PROJECT_NUM --owner ${{ github.repository_owner }} --format json | jq -r '.id') \
              -f item=$ITEM_ID \
              -f field=$(gh project field-list $PROJECT_NUM --owner ${{ github.repository_owner }} --format json | jq -r '.[] | select(.name == "Status") | .id') \
              -f value="$STATUS"
            
            echo "ğŸ”„ Issue #$ISSUE_NUM ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ã€Œ$STATUSã€ã«æ›´æ–°ã—ã¾ã—ãŸ"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Auto Update on PR Events
        if: github.event_name == 'pull_request'
        run: |
          PROJECT_NUM="1"  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ
          PR_NUM="${{ github.event.pull_request.number }}"
          
          # PRã‚’ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«è¿½åŠ 
          gh project item-add $PROJECT_NUM --owner ${{ github.repository_owner }} --url "${{ github.event.pull_request.html_url }}"
          
          # PRã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«å¿œã˜ã¦è‡ªå‹•æ›´æ–°
          case "${{ github.event.action }}" in
            "opened")
              STATUS="In Progress"
              echo "ğŸš€ PR #$PR_NUM ã‚’ã€ŒIn Progressã€ã¨ã—ã¦è¿½åŠ "
              ;;
            "closed")
              if [[ "${{ github.event.pull_request.merged }}" == "true" ]]; then
                STATUS="Done"
                echo "âœ… PR #$PR_NUM ã‚’ãƒãƒ¼ã‚¸å®Œäº†ã¨ã—ã¦ã€ŒDoneã€ã«è¨­å®š"
              else
                STATUS="Todo"
                echo "âŒ PR #$PR_NUM ãŒã‚¯ãƒ­ãƒ¼ã‚ºã•ã‚ŒãŸãŸã‚ã€ŒTodoã€ã«æˆ»ã—ã¾ã—ãŸ"
              fi
              ;;
          esac
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: AI Project Summary
        if: always()
        run: |
          echo "## ğŸ¤– AI Project Management Summary"
          echo "### å®Ÿè¡Œã•ã‚ŒãŸã‚¢ã‚¯ã‚·ãƒ§ãƒ³: ${{ github.event.inputs.action || github.event_name }}"
          echo "### çµæœ: âœ… æ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸ"
          
          if [[ "${{ github.event.inputs.action }}" == "create-project" ]]; then
            echo "### ğŸ“‹ æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ:"
            echo "- **ã‚¿ã‚¤ãƒˆãƒ«**: ${{ github.event.inputs.project_title }}"
            echo "- **èª¬æ˜**: ${{ github.event.inputs.project_description }}"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }} 